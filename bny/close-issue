#!/usr/bin/env bun
//
// bny close-issue — close the GH issue for a feature
//
// reads specs/<branch>/issue.txt and closes the issue with a comment.
//
// usage:
//   bny close-issue              # current feature branch
//   bny close-issue 001-auth     # explicit feature
//

import { existsSync, readFileSync } from "node:fs"
import { success, error } from "../src/lib/result.ts"
import { find_root, current_feature, feature_paths } from "./lib/feature.ts"

// -- parse args --

const argv = process.argv.slice(2)
let target: string | null = null

for (const arg of argv) {
  if (arg === "--help" || arg === "-h") {
    process.stdout.write("usage: bny close-issue [feature-name]\n")
    process.exit(0)
  } else if (!arg.startsWith("-")) {
    target = arg
  }
}

// -- resolve feature --

const root = find_root()
const name = target || current_feature()

if (!name) {
  const result = error({ feature: [{ code: "not_found", message: "no feature specified and not on a feature branch" }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
  process.exit()
}

const paths = feature_paths(root, name)

// -- guards --

if (!existsSync(paths.issue)) {
  const result = error({ issue: [{ code: "missing", message: `${paths.issue} does not exist — no issue tracked for this feature` }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
  process.exit()
}

const issue_number = readFileSync(paths.issue, "utf-8").trim()
if (!issue_number) {
  const result = error({ issue: [{ code: "empty", message: "issue.txt is empty" }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
  process.exit()
}

// -- close issue --

const comment = `Completed via bny implement on branch \`${name}\`.`

const gh = Bun.spawnSync([
  "gh", "issue", "close", issue_number,
  "--comment", comment,
], { stdout: "pipe", stderr: "pipe", cwd: root })

if (gh.exitCode !== 0) {
  const msg = new TextDecoder().decode(gh.stderr).trim()
  const result = error({ gh: [{ code: "close_failed", message: msg || "gh issue close failed" }] })
  process.stdout.write(JSON.stringify(result, null, 2) + "\n")
  process.exitCode = 1
  process.exit()
}

// -- output --

const meta = {
  path: "/bny/close-issue",
  timestamp: new Date().toISOString(),
  duration_ms: 0,
}
const result = success({ issue_number, name, closed: true }, meta)
process.stdout.write(JSON.stringify(result, null, 2) + "\n")
